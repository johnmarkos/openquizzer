<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Quiz</title>
  <meta name="description" content="Quiz app" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet" />
  <meta name="color-scheme" content="light dark" />
  <style>
    :root {
      --bg: #0d1117;
      --bg-secondary: #161b22;
      --border: #30363d;
      --text: #c9d1d9;
      --text-muted: #8b949e;
      --accent: #58a6ff;
      --accent-alpha: rgba(88, 166, 255, 0.1);
      --success: #3fb950;
      --success-alpha: rgba(63, 185, 80, 0.1);
      --error: #f85149;
      --error-alpha: rgba(248, 81, 73, 0.1);
    }

    @media (prefers-color-scheme: light) {
      :root {
        --bg: #ffffff;
        --bg-secondary: #f6f8fa;
        --border: #d0d7de;
        --text: #1f2328;
        --text-muted: #656d76;
        --accent: #0969da;
        --accent-alpha: rgba(9, 105, 218, 0.1);
        --success: #1a7f37;
        --success-alpha: rgba(26, 127, 55, 0.1);
        --error: #cf222e;
        --error-alpha: rgba(207, 34, 46, 0.1);
      }
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html {
      font-size: 16px;
    }

    body {
      background-color: var(--bg);
      color: var(--text);
      font-family:
        "JetBrains Mono", "SF Mono", "Fira Code", "Consolas", monospace;
      line-height: 1.6;
      min-height: 100vh;
      min-height: 100dvh;
      padding: 1rem;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
    }

    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border);
      margin-bottom: 1rem;
    }

    .header h1 {
      font-size: 0.875rem;
      font-weight: 600;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .progress {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    /* Landing view */
    .landing {
      padding: 1rem 0;
    }

    .landing h2 {
      font-size: 1.25rem;
      margin-bottom: 0.5rem;
    }

    .landing p {
      color: var(--text-muted);
      font-size: 0.875rem;
      margin-bottom: 1.5rem;
    }

    .unit-list {
      list-style: none;
    }

    .unit-item {
      margin-bottom: 1rem;
    }

    .unit-title {
      font-size: 0.875rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--text-muted);
    }

    .chapter-list {
      list-style: none;
    }

    .chapter-btn {
      display: block;
      width: 100%;
      text-align: left;
      padding: 0.75rem 1rem;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      font-family: inherit;
      font-size: 0.875rem;
      cursor: pointer;
      margin-bottom: 0.5rem;
      transition: border-color 0.15s;
    }

    .chapter-btn:hover:not(:disabled) {
      border-color: var(--accent);
    }

    .chapter-btn:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    .chapter-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .chapter-btn.loading {
      opacity: 0.7;
      cursor: wait;
    }

    .chapter-btn.practice-all-btn {
      background: var(--accent-alpha);
      border-color: var(--accent);
      font-weight: 500;
    }

    /* Practice view */
    .practice {
      display: none;
    }

    .practice.active {
      display: block;
    }

    .landing.hidden {
      display: none;
    }

    .chapter-header {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-bottom: 1.5rem;
    }

    .problem-id {
      display: none;
      font-size: 0.7rem;
      opacity: 0.35;
      margin-bottom: 0.25rem;
      user-select: all;
    }

    .question {
      font-size: 1rem;
      margin-bottom: 1.5rem;
      line-height: 1.5;
    }

    .options {
      list-style: none;
      margin-bottom: 1rem;
    }

    .option-btn {
      display: block;
      width: 100%;
      text-align: left;
      padding: 0.875rem 1rem;
      background: var(--bg-secondary);
      border: 2px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      font-family: inherit;
      font-size: 0.875rem;
      cursor: pointer;
      margin-bottom: 0.5rem;
      transition:
        border-color 0.15s,
        background-color 0.15s;
    }

    .option-btn:hover:not(:disabled) {
      border-color: var(--accent);
    }

    .option-btn:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    .option-btn:disabled {
      cursor: default;
    }

    .option-btn.correct {
      border-color: var(--success);
      background: var(--success-alpha);
    }

    .option-btn.incorrect {
      border-color: var(--error);
      background: var(--error-alpha);
    }

    /* Feedback */
    .feedback {
      display: none;
      padding: 1rem;
      border-radius: 6px;
      margin-bottom: 1rem;
      font-size: 0.875rem;
      line-height: 1.5;
    }

    .feedback.visible {
      display: block;
    }

    .feedback.correct {
      background: var(--success-alpha);
      border: 1px solid var(--success);
    }

    .feedback.incorrect {
      background: var(--error-alpha);
      border: 1px solid var(--error);
    }

    .feedback-title {
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .feedback.correct .feedback-title {
      color: var(--success);
    }

    .feedback.incorrect .feedback-title {
      color: var(--error);
    }

    /* Error message */
    .error-msg {
      display: none;
      padding: 1rem;
      border-radius: 6px;
      margin-bottom: 1rem;
      font-size: 0.875rem;
      background: var(--error-alpha);
      border: 1px solid var(--error);
      color: var(--error);
    }

    .error-msg.visible {
      display: block;
    }

    /* Navigation */
    .nav-btn {
      display: inline-block;
      padding: 0.75rem 1.5rem;
      background: var(--accent);
      border: none;
      border-radius: 6px;
      color: #fff;
      font-family: inherit;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: opacity 0.15s;
    }

    .nav-btn:hover {
      opacity: 0.9;
    }

    .nav-btn:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    .nav-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .nav-btn.secondary {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      color: var(--text);
    }

    .nav-btn.hidden {
      display: none;
    }

    .nav-row {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
    }

    .nav-row.results-nav {
      justify-content: center;
    }

    /* Results view */
    .results {
      display: none;
      text-align: center;
      padding: 2rem 0;
    }

    .results.active {
      display: block;
    }

    .results h2 {
      font-size: 1.25rem;
      margin-bottom: 1rem;
    }

    .score {
      font-size: 3rem;
      font-weight: 600;
      color: var(--accent);
      margin-bottom: 0.5rem;
    }

    .score-label {
      color: var(--text-muted);
      font-size: 0.875rem;
      margin-bottom: 2rem;
    }

    /* Quit link in practice mode */
    .quit-link {
      color: var(--text-muted);
      text-decoration: none;
      font-size: 0.75rem;
      cursor: pointer;
      background: none;
      border: none;
      font-family: inherit;
      padding: 0;
    }

    .quit-link:hover {
      color: var(--error);
    }

    .quit-link:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    /* Back link */
    .back-link {
      display: inline-block;
      color: var(--text-muted);
      text-decoration: none;
      font-size: 0.75rem;
      margin-bottom: 1rem;
    }

    .back-link:hover {
      color: var(--accent);
    }

    .back-link:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    /* Hidden utility class */
    .hidden-container {
      display: none !important;
    }

    /* Numeric input */
    .numeric-input-container {
      margin-bottom: 1rem;
    }

    .numeric-input-row {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .numeric-input {
      flex: 1;
      padding: 0.875rem 1rem;
      background: var(--bg-secondary);
      border: 2px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      font-family: inherit;
      font-size: 1rem;
      min-width: 0;
    }

    .numeric-input:focus {
      outline: none;
      border-color: var(--accent);
    }

    .numeric-input:disabled {
      opacity: 0.7;
    }

    .numeric-input.correct {
      border-color: var(--success);
      background: var(--success-alpha);
    }

    .numeric-input.incorrect {
      border-color: var(--error);
      background: var(--error-alpha);
    }

    .numeric-unit {
      color: var(--text-muted);
      font-size: 0.875rem;
      white-space: nowrap;
    }

    .submit-btn {
      padding: 0.875rem 1.5rem;
      background: var(--accent);
      border: none;
      border-radius: 6px;
      color: #fff;
      font-family: inherit;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      white-space: nowrap;
    }

    .submit-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Multi-select */
    .multi-select-hint {
      color: var(--text-muted);
      font-size: 0.75rem;
      margin-bottom: 0.75rem;
    }

    .option-btn.multi-select {
      position: relative;
      padding-left: 2.5rem;
    }

    .option-btn.multi-select::before {
      content: "";
      position: absolute;
      left: 0.875rem;
      top: 50%;
      transform: translateY(-50%);
      width: 18px;
      height: 18px;
      border: 2px solid var(--border);
      border-radius: 4px;
      background: var(--bg);
    }

    .option-btn.multi-select.selected::before {
      background: var(--accent);
      border-color: var(--accent);
    }

    .option-btn.multi-select.selected::after {
      content: "\2713";
      position: absolute;
      left: 0.95rem;
      top: 50%;
      transform: translateY(-50%);
      color: #fff;
      font-size: 0.75rem;
      font-weight: bold;
    }

    .option-btn.multi-select.correct-selected::before {
      background: var(--success);
      border-color: var(--success);
    }

    .option-btn.multi-select.correct-missed {
      border-color: var(--success);
    }

    .option-btn.multi-select.correct-missed::before {
      border-color: var(--success);
    }

    .option-btn.multi-select.incorrect-selected::before {
      background: var(--error);
      border-color: var(--error);
    }

    .multi-submit-row {
      margin-top: 0.5rem;
    }

    /* Ordering */
    .ordering-container {
      margin-bottom: 1rem;
    }

    .ordering-hint {
      color: var(--text-muted);
      font-size: 0.75rem;
      margin-bottom: 0.75rem;
    }

    .ordering-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.875rem 1rem;
      background: var(--bg-secondary);
      border: 2px solid var(--border);
      border-radius: 6px;
      margin-bottom: 0.5rem;
      cursor: pointer;
      transition:
        border-color 0.15s,
        transform 0.1s;
      user-select: none;
    }

    .ordering-item:hover:not(.disabled) {
      border-color: var(--accent);
    }

    .ordering-item.selected {
      border-color: var(--accent);
      background: var(--accent-alpha);
    }

    .ordering-item.disabled {
      cursor: default;
    }

    .ordering-item.correct-position {
      border-color: var(--success);
      background: var(--success-alpha);
    }

    .ordering-item.incorrect-position {
      border-color: var(--error);
      background: var(--error-alpha);
    }

    .ordering-rank {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: var(--border);
      color: var(--text);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: 600;
      flex-shrink: 0;
    }

    .ordering-item.selected .ordering-rank {
      background: var(--accent);
      color: #fff;
    }

    .ordering-item.correct-position .ordering-rank {
      background: var(--success);
    }

    .ordering-item.incorrect-position .ordering-rank {
      background: var(--error);
    }

    .ordering-text {
      flex: 1;
      font-size: 0.875rem;
    }

    /* Two-stage */
    .stage-indicator {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      background: var(--accent-alpha);
      border: 1px solid var(--accent);
      border-radius: 4px;
      font-size: 0.7rem;
      color: var(--accent);
      margin-bottom: 0.75rem;
    }

    .stage-context {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 0.75rem 1rem;
      margin-bottom: 1rem;
      font-size: 0.8rem;
    }

    .stage-context-label {
      color: var(--text-muted);
      font-size: 0.7rem;
      margin-bottom: 0.25rem;
    }

    /* Correct answer display */
    .correct-answer-display {
      margin-top: 0.5rem;
      padding: 0.5rem 0.75rem;
      background: var(--success-alpha);
      border: 1px solid var(--success);
      border-radius: 4px;
      font-size: 0.8rem;
    }

    .correct-answer-label {
      color: var(--success);
      font-weight: 600;
      margin-right: 0.5rem;
    }
  </style>
</head>

<body>
  <div class="container">
    <div id="back-link-container"></div>

    <!-- Landing View -->
    <div id="landing" class="landing">
      <h2 id="landing-title"></h2>
      <p id="landing-description"></p>

      <div id="error-msg" class="error-msg"></div>

      <div id="unit-list"></div>
    </div>

    <!-- Practice View -->
    <div id="practice" class="practice">
      <header class="header">
        <h1 id="practice-title"></h1>
        <div class="header-right">
          <span class="progress" id="progress" aria-label="Question 1 of 10"><span id="current">1</span>/<span
              id="total">10</span></span>
          <button class="quit-link" id="quit-btn" aria-label="Quit session">
            &times; Quit
          </button>
        </div>
      </header>

      <div class="chapter-header" id="chapter-desc"></div>

      <div id="question-container">
        <div id="stage-indicator" class="stage-indicator hidden-container"></div>
        <div id="stage-context" class="stage-context hidden-container">
          <div class="stage-context-label">Your previous answer:</div>
          <div id="stage-context-text"></div>
        </div>
        <span class="problem-id" id="problem-id"></span>
        <p class="question" id="question-text"></p>

        <!-- Multiple choice options -->
        <ul class="options" id="options"></ul>

        <!-- Numeric input -->
        <div id="numeric-container" class="numeric-input-container hidden-container">
          <div class="numeric-input-row">
            <input type="text" inputmode="decimal" id="numeric-input" class="numeric-input"
              placeholder="Enter number..." autocomplete="off" />
            <span class="numeric-unit" id="numeric-unit"></span>
            <button class="submit-btn" id="numeric-submit">Submit</button>
          </div>
          <div id="correct-answer-display" class="correct-answer-display hidden-container">
            <span class="correct-answer-label">Correct:</span>
            <span id="correct-answer-value"></span>
          </div>
        </div>

        <!-- Ordering -->
        <div id="ordering-container" class="ordering-container hidden-container">
          <div class="ordering-hint">
            Tap to select, then tap another to swap. Use Arrow keys to reorder.
          </div>
          <div id="ordering-items"></div>
          <button class="submit-btn" id="ordering-submit">
            Submit Order
          </button>
        </div>

        <!-- Multi-select submit -->
        <div id="multi-submit-container" class="multi-submit-row hidden-container">
          <button class="submit-btn" id="multi-submit">
            Submit Selection
          </button>
        </div>

        <div class="feedback" id="feedback" aria-live="polite">
          <div class="feedback-title" id="feedback-title"></div>
          <div id="feedback-explanation"></div>
        </div>

        <div class="nav-row">
          <button class="nav-btn hidden" id="next-btn">Next</button>
        </div>
      </div>
    </div>

    <!-- Results View -->
    <div id="results" class="results">
      <h2>Session Complete</h2>
      <div class="score" id="score">0%</div>
      <div class="score-label">
        <span id="correct-count">0</span> of
        <span id="total-count">0</span> correct
      </div>
      <div class="nav-row results-nav">
        <button class="nav-btn secondary" id="retry-btn">Try Again</button>
        <button class="nav-btn" id="back-btn">Back to Menu</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { OpenQuizzer } from "./openquizzer.js";
    import { CONFIG } from "./config.js";

    const quiz = new OpenQuizzer();

    const UNITS = CONFIG.units;

    // =============================================
    // Constants & DOM element references
    // =============================================

    const TWO_STAGE_TRANSITION_DELAY = 800; // ms pause between two-stage parts

    // Top-level views
    const landing = document.getElementById("landing");
    const practice = document.getElementById("practice");
    const results = document.getElementById("results");
    const errorMsg = document.getElementById("error-msg");

    // Practice view — header & progress
    const practiceTitle = document.getElementById("practice-title");
    const chapterDesc = document.getElementById("chapter-desc");
    const currentEl = document.getElementById("current");
    const totalEl = document.getElementById("total");
    const progressEl = document.getElementById("progress");
    const quitBtn = document.getElementById("quit-btn");

    // Practice view — question area
    const problemIdEl = document.getElementById("problem-id");
    const questionText = document.getElementById("question-text");
    const optionsEl = document.getElementById("options");
    const feedback = document.getElementById("feedback");
    const feedbackTitle = document.getElementById("feedback-title");
    const feedbackExplanation = document.getElementById(
      "feedback-explanation",
    );
    const nextBtn = document.getElementById("next-btn");

    // Numeric input elements
    const numericContainer = document.getElementById("numeric-container");
    const numericInput = document.getElementById("numeric-input");
    const numericUnit = document.getElementById("numeric-unit");
    const numericSubmit = document.getElementById("numeric-submit");
    const correctAnswerDisplay = document.getElementById(
      "correct-answer-display",
    );
    const correctAnswerValue = document.getElementById(
      "correct-answer-value",
    );

    // Ordering elements
    const orderingContainer = document.getElementById("ordering-container");
    const orderingItems = document.getElementById("ordering-items");
    const orderingSubmit = document.getElementById("ordering-submit");

    // ... existing code ...

    let selectedOrderingIndex = -1; // -1 means nothing selected

    function renderOrderingQuestion(problem, shuffledItems) {
      questionText.textContent = problem.question;
      orderingContainer.classList.remove("hidden-container");
      orderingSubmit.disabled = false;
      orderingItems.innerHTML = "";
      selectedOrderingIndex = -1;

      shuffledItems.forEach(({ originalIndex, text }, visualIndex) => {
        const div = document.createElement("div");
        div.className = "ordering-item";
        div.dataset.originalIndex = originalIndex;
        div.dataset.visualIndex = visualIndex; // track current position
        div.tabIndex = 0; // Make focusable
        div.setAttribute("role", "button"); // Semantic role
        div.setAttribute("aria-pressed", "false");

        const rank = document.createElement("span");
        rank.className = "ordering-rank";
        rank.textContent = visualIndex + 1;

        const textSpan = document.createElement("span");
        textSpan.className = "ordering-text";
        textSpan.textContent = text;

        div.appendChild(rank);
        div.appendChild(textSpan);
        orderingItems.appendChild(div);
      });
    }

    function updateOrderingDisplay(order) {
      // Re-render items in new order
      // We need to map originalIndex -> text from current DOM or problem?
      // Actually, easiest is to just re-append elements in new order

      const currentElements = Array.from(orderingItems.children);
      const map = new Map();
      currentElements.forEach(el => map.set(parseInt(el.dataset.originalIndex), el));

      orderingItems.innerHTML = "";
      order.forEach((originalIndex, i) => {
        const el = map.get(originalIndex);
        if (el) {
          el.dataset.visualIndex = i;
          el.querySelector(".ordering-rank").textContent = i + 1;
          orderingItems.appendChild(el);
        }
      });

      // Re-apply selection state if needed
      if (selectedOrderingIndex !== -1) {
        const selectedEl = orderingItems.children[selectedOrderingIndex];
        if (selectedEl) {
          selectedEl.classList.add("selected");
          selectedEl.setAttribute("aria-pressed", "true");
          selectedEl.focus();
        }
      }
    }

    // ... existing code ...

    quiz.on(
      "orderingResult",
      ({ userOrder, correctOrder, correct, explanation }) => {
        const items = orderingItems.querySelectorAll(".ordering-item");
        items.forEach((item) => {
          item.classList.add("disabled");
          item.removeAttribute("tabindex"); // Remove focusability after submit
          const originalIndex = parseInt(item.dataset.originalIndex);

          // For result display, we want to show if this ITEM is in the correct RANK
          // userOrder is the array of originalIndices in visual order.
          // visual index 'i' contains originalIndex 'userOrder[i]'.
          // The correct originalIndex at position 'i' is 'correctOrder[i]'.

          // So for the item visually at 'i', is it the correct item?
          // item.dataset.visualIndex should match i.

          const visualIndex = parseInt(item.dataset.visualIndex);
          const itemOriginalIndex = parseInt(item.dataset.originalIndex);
          const expectedOriginalIndex = correctOrder[visualIndex];

          if (itemOriginalIndex === expectedOriginalIndex) {
            item.classList.add("correct-position");
          } else {
            item.classList.add("incorrect-position");
          }
        });

        orderingSubmit.disabled = true;
        selectedOrderingIndex = -1; // clear selection
        showFeedback(correct, explanation);
      },
    );

    // ... existing code ...

    orderingItems.addEventListener("click", (e) => {
      const item = e.target.closest(".ordering-item");
      if (!item || item.classList.contains("disabled")) return;

      // Find visual index in the list
      const visualIndex = Array.from(orderingItems.children).indexOf(item);

      if (selectedOrderingIndex === -1) {
        // Select
        selectedOrderingIndex = visualIndex;
        item.classList.add("selected");
        item.setAttribute("aria-pressed", "true");
      } else if (selectedOrderingIndex === visualIndex) {
        // Deselect
        selectedOrderingIndex = -1;
        item.classList.remove("selected");
        item.setAttribute("aria-pressed", "false");
      } else {
        // Swap
        quiz.moveOrderingItem(selectedOrderingIndex, visualIndex);
        // Engine emits orderingUpdate, which we handle to re-render.
        // We want to keep the "selection" following the item? 
        // Or clear it? 
        // "Tap to select, tap another to swap" -> usually clears selection after swap.
        selectedOrderingIndex = -1;
      }
    });

    orderingItems.addEventListener("keydown", (e) => {
      if (e.target.classList.contains("ordering-item")) {
        const visualIndex = Array.from(orderingItems.children).indexOf(e.target);

        if (e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          // Toggle selection
          if (selectedOrderingIndex === visualIndex) {
            selectedOrderingIndex = -1;
            e.target.classList.remove("selected");
            e.target.setAttribute("aria-pressed", "false");
          } else {
            // If something else was selected, assume we want to swap? 
            // Or just change selection? 
            // Standard "listbox" behavior might be change selection.
            // But for "Swap" model, if I select A, then nav to B and press Enter, I expect Swap.
            if (selectedOrderingIndex !== -1 && selectedOrderingIndex !== visualIndex) {
              quiz.moveOrderingItem(selectedOrderingIndex, visualIndex);
              selectedOrderingIndex = -1;
            } else {
              selectedOrderingIndex = visualIndex;
              e.target.classList.add("selected");
              e.target.setAttribute("aria-pressed", "true");
            }
          }
        } else if (e.key === "ArrowUp") {
          // If selected, Move. If not, standard focus (handled by browser usually, but we might need to help).
          // Actually standard focus nav doesn't work automatically for divs unless we handle it 
          // or they are in a container that manages it.
          // Let's implement focus nav + move.
          e.preventDefault();

          if (selectedOrderingIndex === visualIndex) {
            // Move Logic
            if (visualIndex > 0) {
              quiz.moveOrderingItem(visualIndex, visualIndex - 1);
              selectedOrderingIndex = visualIndex - 1; // Follow the item
            }
          } else {
            // Focus Logic
            const prev = orderingItems.children[visualIndex - 1];
            if (prev) prev.focus();
          }
        } else if (e.key === "ArrowDown") {
          e.preventDefault();
          if (selectedOrderingIndex === visualIndex) {
            // Move Logic
            if (visualIndex < orderingItems.children.length - 1) {
              quiz.moveOrderingItem(visualIndex, visualIndex + 1);
              selectedOrderingIndex = visualIndex + 1; // Follow the item
            }
          } else {
            // Focus Logic
            const next = orderingItems.children[visualIndex + 1];
            if (next) next.focus();
          }
        }
      }
    });

    orderingSubmit.addEventListener("click", () => {
      quiz.submitOrdering();
    });

    multiSubmit.addEventListener("click", () => {
      quiz.submitMultiSelect();
    });

    nextBtn.addEventListener("click", () => {
      quiz.next();
    });

    retryBtn.addEventListener("click", () => {
      results.classList.remove("active");
      practice.classList.add("active");
      quiz.retry();
    });

    backBtn.addEventListener("click", backToMenu);
    quitBtn.addEventListener("click", backToMenu);

    // =============================================
    // Initialize
    // =============================================

    document.title = CONFIG.title;
    document
      .querySelector('meta[name="description"]')
      .setAttribute("content", CONFIG.description);
    document.getElementById("landing-title").textContent = CONFIG.title;
    document.getElementById("landing-description").textContent =
      CONFIG.description;
    if (CONFIG.backLink) {
      const link = document.createElement("a");
      link.href = CONFIG.backLink.href;
      link.className = "back-link";
      link.textContent = CONFIG.backLink.text;
      document.getElementById("back-link-container").appendChild(link);
    }

    renderUnitList();
  </script>
</body>

</html>